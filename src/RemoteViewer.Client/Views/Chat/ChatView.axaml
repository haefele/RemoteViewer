<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mi="using:Material.Icons.Avalonia"
        xmlns:controls="using:RemoteViewer.Client.Controls"
        xmlns:hub="using:RemoteViewer.Client.Services.HubClient"
        xmlns:local="using:RemoteViewer.Client.Views.Chat"
        x:Class="RemoteViewer.Client.Views.Chat.ChatView"
        x:DataType="local:ChatViewModel"
        x:Name="ChatWindow"
        Icon="/Assets/avalonia-logo.ico"
        Title="Chat"
        Width="340"
        Height="440"
        CanResize="False"
        ShowInTaskbar="True"
        WindowStartupLocation="CenterOwner">

    <Grid RowDefinitions="*,Auto" Classes="m-sm">
        <!-- Message list -->
        <ScrollViewer Grid.Row="0"
                      x:Name="MessageScrollViewer"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled">
            <ItemsControl ItemsSource="{Binding Messages}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="hub:ChatMessageDisplay">
                        <Border Classes="my-xxs px-sm py-sm rounded-md"
                                Classes.self="{Binding IsFromSelf}"
                                Classes.other="{Binding !IsFromSelf}">
                            <Border.Styles>
                                <Style Selector="Border.self">
                                    <Setter Property="HorizontalAlignment" Value="Right"/>
                                    <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
                                </Style>
                                <Style Selector="Border.other">
                                    <Setter Property="HorizontalAlignment" Value="Left"/>
                                    <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
                                </Style>
                            </Border.Styles>
                            <StackPanel MaxWidth="240">
                                <!-- Sender name (hidden for self) -->
                                <TextBlock Text="{Binding SenderDisplayName}"
                                           Classes="small text-secondary"
                                           FontWeight="SemiBold"
                                           IsVisible="{Binding !IsFromSelf}"/>
                                <!-- Message text (selectable) -->
                                <SelectableTextBlock Text="{Binding Text}"
                                                     Classes="wrap"
                                                     FontSize="13"
                                                     LineHeight="20"/>
                                <!-- Link buttons -->
                                <ItemsControl ItemsSource="{Binding Links}"
                                              IsVisible="{Binding Links.Count}"
                                              Classes="mt-xs">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:DataType="hub:ChatLinkDisplay">
                                            <Button Command="{Binding #ChatWindow.((local:ChatViewModel)DataContext).OpenLinkCommand}"
                                                    CommandParameter="{Binding Url}"
                                                    Classes="px-sm py-xs mt-xxs items-start">
                                                <StackPanel Classes="flex-row gap-sm">
                                                    <mi:MaterialIcon Kind="Link" Width="{StaticResource IconSizeSM}" Height="{StaticResource IconSizeSM}" Classes="justify-center"/>
                                                    <StackPanel>
                                                        <TextBlock Text="{Binding Domain}" Classes="caption" FontWeight="SemiBold"/>
                                                        <TextBlock Text="{Binding Url}" Classes="small-muted truncate"
                                                                   MaxWidth="180"/>
                                                    </StackPanel>
                                                </StackPanel>
                                            </Button>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                <!-- Timestamp -->
                                <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:HH:mm}'}"
                                           Classes="small-muted text-right"/>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Empty state -->
        <TextBlock Grid.Row="0"
                   Text="No messages yet"
                   Classes="caption muted center"
                   IsVisible="{Binding !Messages.Count}"/>

        <!-- Input area -->
        <StackPanel Grid.Row="1" Classes="my-sm gap-xs">
            <!-- Character limit warning -->
            <TextBlock Text="{Binding CharactersRemaining, StringFormat='{}{0} characters remaining'}"
                       Classes="small-muted items-end"
                       IsVisible="{Binding IsNearLimit}"
                       Classes.warning="{Binding IsNearLimit}"
                       Classes.error="{Binding IsAtLimit}">
                <TextBlock.Styles>
                    <Style Selector="TextBlock.warning">
                        <Setter Property="Foreground" Value="{DynamicResource WarningBrush}"/>
                    </Style>
                    <Style Selector="TextBlock.error">
                        <Setter Property="Foreground" Value="{DynamicResource ErrorBrush}"/>
                    </Style>
                </TextBlock.Styles>
            </TextBlock>

            <TextBox Text="{Binding MessageInput}"
                     MaxLength="{Binding MaxLength}"
                     Watermark="Type a message..."
                     AcceptsReturn="False"
                     TextWrapping="Wrap"
                     MaxHeight="80"
                     x:Name="MessageInputBox"
                     KeyDown="MessageInputBox_KeyDown">
                <TextBox.InnerRightContent>
                    <Button Command="{Binding SendMessageCommand}"
                            ToolTip.Tip="Send message"
                            Classes="icon-button"
                            Width="28"
                            Height="28">
                        <mi:MaterialIcon Kind="Send" Width="18" Height="18"
                                         Classes="text-accent"/>
                    </Button>
                </TextBox.InnerRightContent>
            </TextBox>
        </StackPanel>
    </Grid>
</Window>
