<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mi="using:Material.Icons.Avalonia"
        xmlns:controls="using:RemoteViewer.Client.Controls"
        xmlns:hub="using:RemoteViewer.Client.Services.HubClient"
        xmlns:local="using:RemoteViewer.Client.Views.Chat"
        xmlns:theme="using:RemoteViewer.Client.Themes"
        x:Class="RemoteViewer.Client.Views.Chat.ChatView"
        x:DataType="local:ChatViewModel"
        x:Name="ChatWindow"
        Icon="/Assets/avalonia-logo.ico"
        Title="Chat"
        Width="340"
        Height="440"
        CanResize="False"
        ShowInTaskbar="True"
        WindowStartupLocation="CenterOwner">

    <Grid RowDefinitions="*,Auto" Margin="{theme:Spacing SM}">
        <!-- Message list -->
        <ScrollViewer Grid.Row="0"
                      x:Name="MessageScrollViewer"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled">
            <ItemsControl ItemsSource="{Binding Messages}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="hub:ChatMessageDisplay">
                        <Border Margin="{theme:Spacing Y=XXS}"
                                Padding="{theme:Spacing X=SM, Y=SM}"
                                CornerRadius="8"
                                Classes.self="{Binding IsFromSelf}"
                                Classes.other="{Binding !IsFromSelf}">
                            <Border.Styles>
                                <Style Selector="Border.self">
                                    <Setter Property="HorizontalAlignment" Value="Right"/>
                                    <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
                                </Style>
                                <Style Selector="Border.other">
                                    <Setter Property="HorizontalAlignment" Value="Left"/>
                                    <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
                                </Style>
                            </Border.Styles>
                            <StackPanel MaxWidth="240">
                                <!-- Sender name (hidden for self) -->
                                <TextBlock Text="{Binding SenderDisplayName}"
                                           Classes="m1"
                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                           FontWeight="SemiBold"
                                           IsVisible="{Binding !IsFromSelf}"/>
                                <!-- Message text (selectable) -->
                                <SelectableTextBlock Text="{Binding Text}"
                                                     TextWrapping="Wrap"/>
                                <!-- Link buttons -->
                                <ItemsControl ItemsSource="{Binding Links}"
                                              IsVisible="{Binding Links.Count}"
                                              Margin="{theme:Spacing Top=XS}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:DataType="hub:ChatLinkDisplay">
                                            <Button Command="{Binding #ChatWindow.((local:ChatViewModel)DataContext).OpenLinkCommand}"
                                                    CommandParameter="{Binding Url}"
                                                    Padding="{theme:Spacing X=SM, Y=XS}"
                                                    Margin="{theme:Spacing Top=XXS}"
                                                    HorizontalAlignment="Left">
                                                <StackPanel Orientation="Horizontal" Spacing="{theme:Spacing SM}">
                                                    <mi:MaterialIcon Kind="Link" Classes="icon-xs" VerticalAlignment="Center"/>
                                                    <StackPanel>
                                                        <TextBlock Text="{Binding Domain}" Classes="m1" FontWeight="SemiBold"/>
                                                        <TextBlock Text="{Binding Url}" Classes="m2"
                                                                   TextTrimming="CharacterEllipsis"
                                                                   MaxWidth="180"/>
                                                    </StackPanel>
                                                </StackPanel>
                                            </Button>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                <!-- Timestamp -->
                                <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:HH:mm}'}"
                                           Classes="m2"
                                           TextAlignment="Right"/>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Empty state -->
        <TextBlock Grid.Row="0"
                   Text="No messages yet"
                   Classes="m1 muted"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   IsVisible="{Binding !Messages.Count}"/>

        <!-- Input area -->
        <StackPanel Grid.Row="1" Margin="{theme:Spacing Top=SM}" 
                    Spacing="{theme:Spacing XS}">
            <!-- Character limit warning -->
            <TextBlock Text="{Binding CharactersRemaining, StringFormat='{}{0} characters remaining'}"
                       Classes="m2"
                       HorizontalAlignment="Right"
                       IsVisible="{Binding IsNearLimit}"
                       Classes.warning="{Binding IsNearLimit}"
                       Classes.error="{Binding IsAtLimit}">
                <TextBlock.Styles>
                    <Style Selector="TextBlock.warning">
                        <Setter Property="Foreground" Value="{DynamicResource WarningBrush}"/>
                    </Style>
                    <Style Selector="TextBlock.error">
                        <Setter Property="Foreground" Value="{DynamicResource ErrorBrush}"/>
                    </Style>
                </TextBlock.Styles>
            </TextBlock>

            <TextBox Text="{Binding MessageInput}"
                     MaxLength="{Binding MaxLength}"
                     Watermark="Type a message..."
                     AcceptsReturn="False"
                     TextWrapping="Wrap"
                     MaxHeight="80"
                     x:Name="MessageInputBox"
                     KeyDown="MessageInputBox_KeyDown">
                <TextBox.InnerRightContent>
                    <Button Command="{Binding SendMessageCommand}"
                            ToolTip.Tip="Send message"
                            Classes="icon-button"
                            Width="32"
                            Height="32">
                        <mi:MaterialIcon Kind="Send"
                                         Classes="icon-xs"
                                         Foreground="{DynamicResource AccentBrush}"/>
                    </Button>
                </TextBox.InnerRightContent>
            </TextBox>
        </StackPanel>
    </Grid>
</Window>
