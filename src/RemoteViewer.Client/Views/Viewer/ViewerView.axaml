<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:RemoteViewer.Client.Views.Viewer"
        xmlns:conv="using:RemoteViewer.Client.Converters"
        xmlns:toastControls="using:RemoteViewer.Client.Controls.Toasts"
        xmlns:fileTransfer="using:RemoteViewer.Client.Controls.FileTransfer"
        xmlns:mi="using:Material.Icons.Avalonia"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        x:Class="RemoteViewer.Client.Views.Viewer.ViewerView"
        x:DataType="vm:ViewerViewModel"

        Icon="/Assets/avalonia-logo.ico"
        Title="{Binding Title}"
        Width="1280"
        Height="720"
        WindowStartupLocation="CenterScreen"

        DataContextChanged="Window_DataContextChanged"
        Opened="Window_Opened"
        Deactivated="Window_Deactivated"
        Closed="Window_Closed"
        PointerMoved="Window_PointerMoved">

    <Design.DataContext>
        <vm:ViewerViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="Auto,*">
        <!-- Unified Toolbar (switches between windowed and fullscreen styling) -->
        <Border x:Name="ToolbarBorder"
                Grid.Row="0"
                Classes.fullscreen="{Binding IsFullscreen}"
                Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                Padding="8,6"
                PointerEntered="Toolbar_PointerEntered"
                PointerExited="Toolbar_PointerExited">

            <!-- Visibility with MultiBinding -->
            <Border.IsVisible>
                <MultiBinding Converter="{x:Static conv:ToolbarVisibilityConverter.Instance}">
                    <Binding Path="IsFullscreen"/>
                    <Binding Path="IsToolbarVisible"/>
                </MultiBinding>
            </Border.IsVisible>

            <!-- Fullscreen mode overrides -->
            <Border.Styles>
                <Style Selector="Border#ToolbarBorder.fullscreen">
                    <Setter Property="Grid.RowSpan" Value="2"/>
                    <Setter Property="ZIndex" Value="1"/>
                    <Setter Property="Opacity" Value="0.9"/>
                    <Setter Property="CornerRadius" Value="0,0,8,8"/>
                    <Setter Property="HorizontalAlignment" Value="Center"/>
                    <Setter Property="VerticalAlignment" Value="Top"/>
                </Style>
            </Border.Styles>

            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                <!-- Fullscreen toggle (dynamic icon + tooltip) -->
                <Button Command="{Binding ToggleFullscreenCommand}"
                        ToolTip.Tip="{Binding IsFullscreen, Converter={x:Static conv:BoolToFullscreenTooltipConverter.Instance}}"
                        Background="Transparent"
                        BorderThickness="0"
                        Width="32" Height="32"
                        Padding="0">
                    <mi:MaterialIcon Kind="{Binding IsFullscreen, Converter={x:Static conv:BoolToFullscreenIconConverter.Instance}}"
                                     Width="20" Height="20"/>
                </Button>

                <!-- Switch display button -->
                <Button Command="{Binding NextDisplayCommand}"
                        ToolTip.Tip="Switch display"
                        Background="Transparent"
                        BorderThickness="0"
                        Width="32" Height="32"
                        Padding="0">
                    <mi:MaterialIcon Kind="MonitorMultiple" Width="20" Height="20"/>
                </Button>

                <!-- Toggle input button -->
                <Button Command="{Binding ToggleInputCommand}"
                        ToolTip.Tip="{Binding IsInputEnabled, Converter={x:Static conv:BoolToInputTooltipConverter.Instance}}"
                        Background="Transparent"
                        BorderThickness="0"
                        Width="32" Height="32"
                        Padding="0">
                    <mi:MaterialIcon Kind="{Binding IsInputEnabled, Converter={x:Static conv:BoolToInputIconConverter.Instance}}"
                                     Width="20" Height="20"/>
                </Button>

                <!-- Send File button -->
                <Button Command="{Binding SendFileCommand}"
                        ToolTip.Tip="Send file to presenter"
                        Background="Transparent"
                        BorderThickness="0"
                        Width="32" Height="32"
                        Padding="0">
                    <mi:MaterialIcon Kind="FileUpload" Width="20" Height="20"/>
                </Button>

                <!-- Separator -->
                <Border Width="1"
                        Margin="0,4"
                        Background="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>

                <!-- Participants flyout -->
                <Button ToolTip.Tip="Participants"
                        Background="Transparent"
                        BorderThickness="0"
                        Width="32" Height="32"
                        Padding="0">
                    <Button.Flyout>
                        <Flyout Placement="Bottom">
                            <StackPanel MinWidth="180">
                                <ItemsControl ItemsSource="{Binding Participants}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:DataType="vm:ParticipantDisplay">
                                            <Border Padding="8,6"
                                                    CornerRadius="4"
                                                    Background="{Binding IsPresenter, Converter={x:Static conv:BoolToPresenterBackgroundConverter.Instance}}">
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <mi:MaterialIcon Kind="{Binding IsPresenter, Converter={x:Static conv:BoolToParticipantIconConverter.Instance}}"
                                                                     Width="16" Height="16"
                                                                     ToolTip.Tip="{Binding IsPresenter, Converter={x:Static conv:BoolToRoleTooltipConverter.Instance}}"/>
                                                    <TextBlock Text="{Binding DisplayName}" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Flyout>
                    </Button.Flyout>
                    <mi:MaterialIcon Kind="AccountGroup" Width="20" Height="20"/>
                </Button>
                
                <!-- Separator -->
                <Border Width="1" 
                        Margin="0,4" 
                        Background="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>

                <!-- Disconnect button -->
                <Button Command="{Binding DisconnectCommand}"
                        ToolTip.Tip="Disconnect"
                        Background="Transparent"
                        BorderThickness="0"
                        Width="32" Height="32"
                        Padding="0">
                    <mi:MaterialIcon Kind="LanDisconnect" Width="20" Height="20" Foreground="#F44336"/>
                </Button>
            </StackPanel>
        </Border>

        <!-- Frame display (row 1) -->
        <Border Grid.Row="1"
                x:Name="DisplayPanel"
                Background="Black"
                ClipToBounds="True"
                Focusable="True"
                PointerMoved="DisplayPanel_PointerMoved"
                PointerPressed="DisplayPanel_PointerPressed"
                PointerReleased="DisplayPanel_PointerReleased"
                PointerWheelChanged="DisplayPanel_PointerWheelChanged"
                KeyDown="DisplayPanel_KeyDown"
                KeyUp="DisplayPanel_KeyUp">
            <Panel>
                <Image x:Name="FrameImage"
                       Source="{Binding FrameBitmap}"
                       Stretch="Uniform"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"/>
                <Image x:Name="DebugOverlayImage"
                       Source="{Binding DebugOverlayBitmap}"
                       Stretch="Uniform"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       IsHitTestVisible="False"
                       IsVisible="{Binding DebugOverlayBitmap, Converter={x:Static ObjectConverters.IsNotNull}}"/>
            </Panel>
        </Border>

        <!-- File Transfer Progress (row 1, overlay bottom-right, above toasts) -->
        <fileTransfer:FileTransferProgressView Grid.Row="1"
                                               DataContext="{Binding}"
                                               VerticalAlignment="Bottom"
                                               HorizontalAlignment="Right"
                                               Margin="0,0,8,60"
                                               IsHitTestVisible="True"/>

        <!-- Toast Notifications (row 1, overlay bottom-right) -->
        <toastControls:ToastsView Grid.Row="1"
                                  DataContext="{Binding Toasts}"
                                  VerticalAlignment="Bottom"
                                  HorizontalAlignment="Right"
                                  Margin="0,0,8,8"/>
    </Grid>

</Window>
