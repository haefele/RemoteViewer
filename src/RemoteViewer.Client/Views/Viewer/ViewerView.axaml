<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:RemoteViewer.Client.Views.Viewer"
        xmlns:conv="using:RemoteViewer.Client.Converters"
        xmlns:toastControls="using:RemoteViewer.Client.Controls.Toasts"
        xmlns:controls="using:RemoteViewer.Client.Controls"
        xmlns:chatControls="using:RemoteViewer.Client.Views.Chat"
        xmlns:mi="using:Material.Icons.Avalonia"
        xmlns:mik="using:Material.Icons"
        xmlns:dto="using:RemoteViewer.Shared"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        x:Class="RemoteViewer.Client.Views.Viewer.ViewerView"
        x:DataType="vm:ViewerViewModel"

        Icon="/Assets/avalonia-logo.ico"
        Title="Remote Viewer"
        Width="1280"
        Height="720"
        WindowStartupLocation="CenterScreen"
        DragDrop.AllowDrop="True"

        DataContextChanged="Window_DataContextChanged"
        Opened="Window_Opened"
        Deactivated="Window_Deactivated"
        Closed="Window_Closed"
        PointerMoved="Window_PointerMoved">

    <Design.DataContext>
        <vm:ViewerViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="Auto,*">
        <!-- Unified Toolbar (switches between windowed and fullscreen styling) -->
        <Border x:Name="ToolbarBorder"
                Grid.Row="0"
                Classes.fullscreen="{Binding IsFullscreen}"
                Classes="bg-elevated px-sm py-sm"
                PointerEntered="Toolbar_PointerEntered"
                PointerExited="Toolbar_PointerExited">

            <!-- Visibility with MultiBinding -->
            <Border.IsVisible>
                <MultiBinding Converter="{x:Static conv:ToolbarVisibilityConverter.Instance}">
                    <Binding Path="IsFullscreen"/>
                    <Binding Path="IsToolbarVisible"/>
                </MultiBinding>
            </Border.IsVisible>

            <!-- Fullscreen mode overrides -->
            <Border.Styles>
                <Style Selector="Border#ToolbarBorder.fullscreen">
                    <Setter Property="Grid.RowSpan" Value="2"/>
                    <Setter Property="ZIndex" Value="1"/>
                    <Setter Property="Opacity" Value="0.9"/>
                    <Setter Property="CornerRadius" Value="0,0,8,8"/>
                    <Setter Property="HorizontalAlignment" Value="Center"/>
                    <Setter Property="VerticalAlignment" Value="Top"/>
                </Style>
            </Border.Styles>

            <StackPanel Classes="flex-row gap-sm items-center">
                <!-- Fullscreen toggle (dynamic icon + tooltip) -->
                <Button Command="{Binding ToggleFullscreenCommand}"
                        ToolTip.Tip="{Binding IsFullscreen, Converter={conv:BoolToObject TrueValue='Exit fullscreen (F11 / ESC)', FalseValue='Enter fullscreen (F11)'}}"
                        Classes="icon-button">
                    <mi:MaterialIcon Kind="{Binding IsFullscreen, Converter={conv:BoolToObject TrueValue={x:Static mik:MaterialIconKind.FullscreenExit}, FalseValue={x:Static mik:MaterialIconKind.Fullscreen}}}"
                                     Width="20" Height="20"/>
                </Button>

                <!-- Display selection flyout -->
                <Button ToolTip.Tip="Select display"
                        IsVisible="{Binding AvailableDisplays.Count, Converter={x:Static conv:GreaterThanConverter.Instance}, ConverterParameter=1}"
                        Classes="icon-button">
                    <Button.Flyout>
                        <Flyout Placement="Bottom">
                            <StackPanel MinWidth="220" Classes="gap-xxs">
                                <TextBlock Text="Displays"
                                           FontWeight="SemiBold"
                                           Classes="mx-sm mt-xs mb-sm"/>
                                <controls:DisplayMiniMap
                                    AvailableDisplays="{Binding AvailableDisplays}"
                                    CurrentDisplayId="{Binding CurrentDisplayId}"
                                    DisplaySelected="DisplayMiniMap_DisplaySelected"/>
                            </StackPanel>
                        </Flyout>
                    </Button.Flyout>
                    <mi:MaterialIcon Kind="MonitorMultiple" Width="20" Height="20"/>
                </Button>

                <!-- Toggle input button -->
                <Button Command="{Binding ToggleInputCommand}"
                        Classes="icon-button"
                        ToolTip.ShowOnDisabled="True">
                    <ToolTip.Tip>
                        <MultiBinding Converter="{x:Static conv:InputButtonTooltipConverter.Instance}">
                            <Binding Path="IsInputBlockedByPresenter"/>
                            <Binding Path="IsInputEnabled"/>
                        </MultiBinding>
                    </ToolTip.Tip>
                    <mi:MaterialIcon Kind="{Binding IsInputEnabled, Converter={conv:BoolToObject TrueValue={x:Static mik:MaterialIconKind.Mouse}, FalseValue={x:Static mik:MaterialIconKind.MouseOff}}}"
                                     Width="20" Height="20"/>
                </Button>

                <!-- Send Ctrl+Alt+Del button -->
                <Button Command="{Binding SendCtrlAltDelCommand}"
                        IsVisible="{Binding CanSendSecureAttentionSequence}"
                        ToolTip.ShowOnDisabled="True"
                        Classes="icon-button">
                    <ToolTip.Tip>
                        <MultiBinding Converter="{x:Static conv:CtrlAltDelTooltipConverter.Instance}">
                            <Binding Path="IsInputBlockedByPresenter"/>
                            <Binding Path="CanSendSecureAttentionSequence"/>
                        </MultiBinding>
                    </ToolTip.Tip>
                    <mi:MaterialIcon Kind="AccountKey" Width="20" Height="20"/>
                </Button>

                <!-- Send File button -->
                <Button Command="{Binding SendFileCommand}"
                        ToolTip.Tip="Send file to presenter"
                        Classes="icon-button">
                    <mi:MaterialIcon Kind="FileUpload" Width="20" Height="20"/>
                </Button>

                <!-- Separator -->
                <Border Classes="divider-v"/>

                <!-- Participants flyout -->
                <Button ToolTip.Tip="Participants"
                        Classes="icon-button">
                    <Button.Flyout>
                        <Flyout Placement="Bottom">
                            <StackPanel MinWidth="180" Classes="gap-xxs">
                                <TextBlock Text="Participants"
                                           FontWeight="SemiBold"
                                           Classes="mx-sm mt-xs mb-sm"/>
                                <ItemsControl ItemsSource="{Binding Participants}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:DataType="vm:ParticipantDisplay">
                                            <Border Classes="px-sm py-sm rounded-sm"
                                                    Background="{Binding IsPresenter, Converter={x:Static conv:BoolToAccentBrushConverter.Instance}}">
                                                <StackPanel Classes="flex-row gap-sm">
                                                    <mi:MaterialIcon Kind="{Binding IsPresenter, Converter={conv:BoolToObject TrueValue={x:Static mik:MaterialIconKind.Monitor}, FalseValue={x:Static mik:MaterialIconKind.Account}}}"
                                                                     Width="16" Height="16"
                                                                     ToolTip.Tip="{Binding IsPresenter, Converter={conv:BoolToObject TrueValue='Presenter', FalseValue='Viewer'}}"/>
                                                    <TextBlock Text="{Binding DisplayName}" Classes="justify-center"/>
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Flyout>
                    </Button.Flyout>
                    <mi:MaterialIcon Kind="AccountGroup" Width="20" Height="20"/>
                </Button>

                <!-- Chat button -->
                <Button x:Name="ChatButton"
                        ToolTip.Tip="Chat"
                        Classes="icon-button"
                        Command="{Binding ShowChatCommand}">
                    <Panel>
                        <mi:MaterialIcon Kind="Chat" Width="20" Height="20"/>
                        <!-- Unread indicator -->
                        <Ellipse Width="8" Height="8"
                                 Fill="{DynamicResource ErrorBrush}"
                                 Classes="items-end justify-start"
                                 Margin="0,2,2,0"
                                 IsVisible="{Binding Chat.HasUnreadMessages}"/>
                    </Panel>
                </Button>

                <!-- Separator -->
                <Border Classes="divider-v"/>

                <!-- Disconnect button -->
                <Button Command="{Binding DisconnectCommand}"
                        ToolTip.Tip="Disconnect"
                        Classes="icon-button">
                    <mi:MaterialIcon Kind="LanDisconnect" Width="20" Height="20" Classes="text-error"/>
                </Button>
            </StackPanel>
        </Border>

        <!-- Frame display (row 1) -->
        <Border Grid.Row="1"
                x:Name="DisplayPanel"
                Background="Black"
                ClipToBounds="True"
                Focusable="True"
                PointerMoved="DisplayPanel_PointerMoved"
                PointerPressed="DisplayPanel_PointerPressed"
                PointerReleased="DisplayPanel_PointerReleased"
                PointerWheelChanged="DisplayPanel_PointerWheelChanged"
                KeyDown="DisplayPanel_KeyDown"
                KeyUp="DisplayPanel_KeyUp"
                >
            <Panel>
                <Image x:Name="FrameImage"
                       Stretch="Uniform"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"/>
                <Image x:Name="DebugOverlayImage"
                       Stretch="Uniform"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       IsHitTestVisible="False"
                       IsVisible="False"/>

                <!-- Left navigation arrows -->
                <ItemsControl ItemsSource="{Binding LeftAdjacentDisplays}"
                              Classes="items-start justify-center mx-lg">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Classes="flex-col gap-sm"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="dto:DisplayInfo">
                            <Button Command="{Binding $parent[Window].((vm:ViewerViewModel)DataContext).SelectDisplayCommand}"
                                    CommandParameter="{Binding}"
                                    Width="48" Height="80"
                                    Background="{DynamicResource OverlayButtonBrush}"
                                    BorderThickness="0"
                                    CornerRadius="8"
                                    Opacity="0.6"
                                    ToolTip.Tip="{Binding FriendlyName, StringFormat='Navigate to {0} (Ctrl+Left)'}">
                                <Button.Styles>
                                    <Style Selector="Button:pointerover">
                                        <Setter Property="Opacity" Value="1"/>
                                    </Style>
                                </Button.Styles>
                                <mi:MaterialIcon Kind="ChevronLeft" Width="32" Height="32" Foreground="White"/>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Right navigation arrows -->
                <ItemsControl ItemsSource="{Binding RightAdjacentDisplays}"
                              Classes="items-end justify-center mx-lg">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Classes="flex-col gap-sm"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="dto:DisplayInfo">
                            <Button Command="{Binding $parent[Window].((vm:ViewerViewModel)DataContext).SelectDisplayCommand}"
                                    CommandParameter="{Binding}"
                                    Width="48" Height="80"
                                    Background="{DynamicResource OverlayButtonBrush}"
                                    BorderThickness="0"
                                    CornerRadius="8"
                                    Opacity="0.6"
                                    ToolTip.Tip="{Binding FriendlyName, StringFormat='Navigate to {0} (Ctrl+Right)'}">
                                <Button.Styles>
                                    <Style Selector="Button:pointerover">
                                        <Setter Property="Opacity" Value="1"/>
                                    </Style>
                                </Button.Styles>
                                <mi:MaterialIcon Kind="ChevronRight" Width="32" Height="32" Foreground="White"/>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Up navigation arrows -->
                <ItemsControl ItemsSource="{Binding UpAdjacentDisplays}"
                              Classes="items-center justify-start my-lg">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Classes="flex-row gap-sm"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="dto:DisplayInfo">
                            <Button Command="{Binding $parent[Window].((vm:ViewerViewModel)DataContext).SelectDisplayCommand}"
                                    CommandParameter="{Binding}"
                                    Width="80" Height="48"
                                    Background="{DynamicResource OverlayButtonBrush}"
                                    BorderThickness="0"
                                    CornerRadius="8"
                                    Opacity="0.6"
                                    ToolTip.Tip="{Binding FriendlyName, StringFormat='Navigate to {0} (Ctrl+Up)'}">
                                <Button.Styles>
                                    <Style Selector="Button:pointerover">
                                        <Setter Property="Opacity" Value="1"/>
                                    </Style>
                                </Button.Styles>
                                <mi:MaterialIcon Kind="ChevronUp" Width="32" Height="32" Foreground="White"/>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Down navigation arrows -->
                <ItemsControl ItemsSource="{Binding DownAdjacentDisplays}"
                              Classes="items-center justify-end my-lg">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Classes="flex-row gap-sm"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="dto:DisplayInfo">
                            <Button Command="{Binding $parent[Window].((vm:ViewerViewModel)DataContext).SelectDisplayCommand}"
                                    CommandParameter="{Binding}"
                                    Width="80" Height="48"
                                    Background="{DynamicResource OverlayButtonBrush}"
                                    BorderThickness="0"
                                    CornerRadius="8"
                                    Opacity="0.6"
                                    ToolTip.Tip="{Binding FriendlyName, StringFormat='Navigate to {0} (Ctrl+Down)'}">
                                <Button.Styles>
                                    <Style Selector="Button:pointerover">
                                        <Setter Property="Opacity" Value="1"/>
                                    </Style>
                                </Button.Styles>
                                <mi:MaterialIcon Kind="ChevronDown" Width="32" Height="32" Foreground="White"/>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Panel>
        </Border>

        <!-- Toast Notifications (row 1, overlay bottom-right) -->
        <toastControls:ToastsView Grid.Row="1"
                                  DataContext="{Binding Toasts}"
                                  Classes="items-end justify-end mr-sm mb-sm"/>

        <!-- Drop overlay for file transfer (covers entire window) -->
        <controls:DropOverlay x:Name="DropOverlay"
                              Grid.RowSpan="2"
                              Mode="Viewer"
                              IsVisible="False"
                              IsHitTestVisible="False"/>
    </Grid>

</Window>
