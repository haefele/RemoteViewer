<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:RemoteViewer.Client.Views.Viewer"
        xmlns:conv="using:RemoteViewer.Client.Converters"
        xmlns:toastControls="using:RemoteViewer.Client.Controls.Toasts"
        xmlns:mi="using:Material.Icons.Avalonia"
        xmlns:mik="using:Material.Icons"
        xmlns:dto="using:RemoteViewer.Server.SharedAPI"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        x:Class="RemoteViewer.Client.Views.Viewer.ViewerView"
        x:DataType="vm:ViewerViewModel"

        Icon="/Assets/avalonia-logo.ico"
        Title="Remote Viewer"
        Width="1280"
        Height="720"
        WindowStartupLocation="CenterScreen"

        DataContextChanged="Window_DataContextChanged"
        Opened="Window_Opened"
        Deactivated="Window_Deactivated"
        Closed="Window_Closed"
        PointerMoved="Window_PointerMoved">

    <Design.DataContext>
        <vm:ViewerViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="Auto,*">
        <!-- Unified Toolbar (switches between windowed and fullscreen styling) -->
        <Border x:Name="ToolbarBorder"
                Grid.Row="0"
                Classes.fullscreen="{Binding IsFullscreen}"
                Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                Padding="8,6"
                PointerEntered="Toolbar_PointerEntered"
                PointerExited="Toolbar_PointerExited">

            <!-- Visibility with MultiBinding -->
            <Border.IsVisible>
                <MultiBinding Converter="{x:Static conv:ToolbarVisibilityConverter.Instance}">
                    <Binding Path="IsFullscreen"/>
                    <Binding Path="IsToolbarVisible"/>
                </MultiBinding>
            </Border.IsVisible>

            <!-- Fullscreen mode overrides -->
            <Border.Styles>
                <Style Selector="Border#ToolbarBorder.fullscreen">
                    <Setter Property="Grid.RowSpan" Value="2"/>
                    <Setter Property="ZIndex" Value="1"/>
                    <Setter Property="Opacity" Value="0.9"/>
                    <Setter Property="CornerRadius" Value="0,0,8,8"/>
                    <Setter Property="HorizontalAlignment" Value="Center"/>
                    <Setter Property="VerticalAlignment" Value="Top"/>
                </Style>
            </Border.Styles>

            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                <!-- Fullscreen toggle (dynamic icon + tooltip) -->
                <Button Command="{Binding ToggleFullscreenCommand}"
                        ToolTip.Tip="{Binding IsFullscreen, Converter={conv:BoolToObject TrueValue='Exit fullscreen (F11 / ESC)', FalseValue='Enter fullscreen (F11)'}}"
                        Background="Transparent"
                        BorderThickness="0"
                        Width="32" Height="32"
                        Padding="0">
                    <mi:MaterialIcon Kind="{Binding IsFullscreen, Converter={conv:BoolToObject TrueValue={x:Static mik:MaterialIconKind.FullscreenExit}, FalseValue={x:Static mik:MaterialIconKind.Fullscreen}}}"
                                     Width="20" Height="20"/>
                </Button>

                <!-- Display selection flyout -->
                <Button ToolTip.Tip="Select display"
                        Background="Transparent"
                        BorderThickness="0"
                        Width="32" Height="32"
                        Padding="0">
                    <Button.Flyout>
                        <Flyout Placement="Bottom">
                            <StackPanel MinWidth="220" Spacing="2">
                                <TextBlock Text="Select Display"
                                           FontWeight="SemiBold"
                                           Margin="8,4,8,8"/>
                                <ItemsControl ItemsSource="{Binding AvailableDisplays}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:DataType="dto:DisplayInfo">
                                            <Button Command="{Binding $parent[Window].((vm:ViewerViewModel)DataContext).SelectDisplayCommand}"
                                                    CommandParameter="{Binding}"
                                                    Click="DisplaySelectButton_Click"
                                                    HorizontalAlignment="Stretch"
                                                    HorizontalContentAlignment="Left"
                                                    Background="Transparent"
                                                    Padding="8,6"
                                                    CornerRadius="4">
                                                <Grid ColumnDefinitions="Auto,*,Auto">
                                                    <mi:MaterialIcon Grid.Column="0"
                                                                     Kind="{Binding IsPrimary, Converter={conv:BoolToObject TrueValue={x:Static mik:MaterialIconKind.MonitorStar}, FalseValue={x:Static mik:MaterialIconKind.Monitor}}}"
                                                                     Width="16" Height="16"
                                                                     Margin="0,0,8,0"/>
                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                        <TextBlock Text="{Binding FriendlyName}"/>
                                                        <TextBlock FontSize="11"
                                                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}">
                                                            <Run Text="{Binding Width}"/>
                                                            <Run Text=" Ã— "/>
                                                            <Run Text="{Binding Height}"/>
                                                        </TextBlock>
                                                    </StackPanel>
                                                    <mi:MaterialIcon Grid.Column="2"
                                                                     Kind="Check"
                                                                     Width="16" Height="16"
                                                                     Margin="8,0,0,0"
                                                                     Foreground="#4CAF50">
                                                        <mi:MaterialIcon.IsVisible>
                                                            <MultiBinding Converter="{x:Static conv:EqualityConverter.Instance}">
                                                                <Binding Path="Id"/>
                                                                <Binding Path="$parent[Window].((vm:ViewerViewModel)DataContext).CurrentDisplayId"/>
                                                            </MultiBinding>
                                                        </mi:MaterialIcon.IsVisible>
                                                    </mi:MaterialIcon>
                                                </Grid>
                                            </Button>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Flyout>
                    </Button.Flyout>
                    <mi:MaterialIcon Kind="MonitorMultiple" Width="20" Height="20"/>
                </Button>

                <!-- Toggle input button -->
                <Button Command="{Binding ToggleInputCommand}"
                        Background="Transparent"
                        BorderThickness="0"
                        Width="32" Height="32"
                        Padding="0"
                        ToolTip.ShowOnDisabled="True">
                    <ToolTip.Tip>
                        <MultiBinding Converter="{x:Static conv:InputButtonTooltipConverter.Instance}">
                            <Binding Path="IsInputBlockedByPresenter"/>
                            <Binding Path="IsInputEnabled"/>
                        </MultiBinding>
                    </ToolTip.Tip>
                    <mi:MaterialIcon Kind="{Binding IsInputEnabled, Converter={conv:BoolToObject TrueValue={x:Static mik:MaterialIconKind.Mouse}, FalseValue={x:Static mik:MaterialIconKind.MouseOff}}}"
                                     Width="20" Height="20"/>
                </Button>

                <!-- Send Ctrl+Alt+Del button -->
                <Button Command="{Binding SendCtrlAltDelCommand}"
                        ToolTip.ShowOnDisabled="True"
                        Background="Transparent"
                        BorderThickness="0"
                        Width="32" Height="32"
                        Padding="0">
                    <ToolTip.Tip>
                        <MultiBinding Converter="{x:Static conv:CtrlAltDelTooltipConverter.Instance}">
                            <Binding Path="IsInputBlockedByPresenter"/>
                            <Binding Path="CanSendSecureAttentionSequence"/>
                        </MultiBinding>
                    </ToolTip.Tip>
                    <mi:MaterialIcon Kind="AccountKey" Width="20" Height="20"/>
                </Button>

                <!-- Send File button -->
                <Button Command="{Binding SendFileCommand}"
                        ToolTip.Tip="Send file to presenter"
                        Background="Transparent"
                        BorderThickness="0"
                        Width="32" Height="32"
                        Padding="0">
                    <mi:MaterialIcon Kind="FileUpload" Width="20" Height="20"/>
                </Button>

                <!-- Separator -->
                <Border Width="1"
                        Margin="0,4"
                        Background="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>

                <!-- Participants flyout -->
                <Button ToolTip.Tip="Participants"
                        Background="Transparent"
                        BorderThickness="0"
                        Width="32" Height="32"
                        Padding="0">
                    <Button.Flyout>
                        <Flyout Placement="Bottom">
                            <StackPanel MinWidth="180" Spacing="2">
                                <TextBlock Text="Participants"
                                           FontWeight="SemiBold"
                                           Margin="8,4,8,8"/>
                                <ItemsControl ItemsSource="{Binding Participants}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:DataType="vm:ParticipantDisplay">
                                            <Border Padding="8,6"
                                                    CornerRadius="4">
                                                <Border.Background>
                                                    <Binding Path="IsPresenter">
                                                        <Binding.Converter>
                                                            <conv:BoolToObject FalseValue="{x:Static Brushes.Transparent}">
                                                                <conv:BoolToObject.TrueValue>
                                                                    <SolidColorBrush Color="#1A0078D4"/>
                                                                </conv:BoolToObject.TrueValue>
                                                            </conv:BoolToObject>
                                                        </Binding.Converter>
                                                    </Binding>
                                                </Border.Background>
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <mi:MaterialIcon Kind="{Binding IsPresenter, Converter={conv:BoolToObject TrueValue={x:Static mik:MaterialIconKind.Monitor}, FalseValue={x:Static mik:MaterialIconKind.Account}}}"
                                                                     Width="16" Height="16"
                                                                     ToolTip.Tip="{Binding IsPresenter, Converter={conv:BoolToObject TrueValue='Presenter', FalseValue='Viewer'}}"/>
                                                    <TextBlock Text="{Binding DisplayName}" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Flyout>
                    </Button.Flyout>
                    <mi:MaterialIcon Kind="AccountGroup" Width="20" Height="20"/>
                </Button>
                
                <!-- Separator -->
                <Border Width="1" 
                        Margin="0,4" 
                        Background="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>

                <!-- Disconnect button -->
                <Button Command="{Binding DisconnectCommand}"
                        ToolTip.Tip="Disconnect"
                        Background="Transparent"
                        BorderThickness="0"
                        Width="32" Height="32"
                        Padding="0">
                    <mi:MaterialIcon Kind="LanDisconnect" Width="20" Height="20" Foreground="#F44336"/>
                </Button>
            </StackPanel>
        </Border>

        <!-- Frame display (row 1) -->
        <Border Grid.Row="1"
                x:Name="DisplayPanel"
                Background="Black"
                ClipToBounds="True"
                Focusable="True"
                PointerMoved="DisplayPanel_PointerMoved"
                PointerPressed="DisplayPanel_PointerPressed"
                PointerReleased="DisplayPanel_PointerReleased"
                PointerWheelChanged="DisplayPanel_PointerWheelChanged"
                KeyDown="DisplayPanel_KeyDown"
                KeyUp="DisplayPanel_KeyUp"
                >
            <Panel>
                <Image x:Name="FrameImage"
                       Stretch="Uniform"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"/>
                <Image x:Name="DebugOverlayImage"
                       Stretch="Uniform"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       IsHitTestVisible="False"
                       IsVisible="False"/>

                <!-- Left navigation arrow -->
                <Button Command="{Binding NavigateLeftCommand}"
                        IsVisible="{Binding CanNavigateLeft}"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Center"
                        Margin="16,0"
                        Width="48" Height="80"
                        Background="#80000000"
                        BorderThickness="0"
                        CornerRadius="8"
                        Opacity="0.6"
                        ToolTip.Tip="Navigate to left display (Ctrl+Left)">
                    <Button.Styles>
                        <Style Selector="Button:pointerover">
                            <Setter Property="Opacity" Value="1"/>
                        </Style>
                    </Button.Styles>
                    <mi:MaterialIcon Kind="ChevronLeft" Width="32" Height="32" Foreground="White"/>
                </Button>

                <!-- Right navigation arrow -->
                <Button Command="{Binding NavigateRightCommand}"
                        IsVisible="{Binding CanNavigateRight}"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Center"
                        Margin="16,0"
                        Width="48" Height="80"
                        Background="#80000000"
                        BorderThickness="0"
                        CornerRadius="8"
                        Opacity="0.6"
                        ToolTip.Tip="Navigate to right display (Ctrl+Right)">
                    <Button.Styles>
                        <Style Selector="Button:pointerover">
                            <Setter Property="Opacity" Value="1"/>
                        </Style>
                    </Button.Styles>
                    <mi:MaterialIcon Kind="ChevronRight" Width="32" Height="32" Foreground="White"/>
                </Button>
            </Panel>
        </Border>

        <!-- Toast Notifications (row 1, overlay bottom-right) -->
        <toastControls:ToastsView Grid.Row="1"
                                  DataContext="{Binding Toasts}"
                                  VerticalAlignment="Bottom"
                                  HorizontalAlignment="Right"
                                  Margin="0,0,8,8"/>
    </Grid>

</Window>
