<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:mik="using:Material.Icons"
             xmlns:toasts="using:RemoteViewer.Client.Controls.Toasts"
             xmlns:ft="using:RemoteViewer.Client.Services.FileTransfer"
             xmlns:conv="using:RemoteViewer.Client.Converters"
             xmlns:theme="using:RemoteViewer.Client.Themes"
             x:Class="RemoteViewer.Client.Controls.Toasts.ToastsView"
             x:DataType="toasts:ToastsViewModel">

    <ItemsControl ItemsSource="{Binding Items}">
        <ItemsControl.ItemsPanel>
            <ItemsPanelTemplate>
                <StackPanel Spacing="{theme:Gap SM}"/>
            </ItemsPanelTemplate>
        </ItemsControl.ItemsPanel>

        <ItemsControl.DataTemplates>
            <!-- Regular text toast -->
            <DataTemplate x:DataType="toasts:ToastItemViewModel">
                <Border CornerRadius="{StaticResource CornerRadiusLG}"
                        MaxWidth="340"
                        MinWidth="220"
                        BoxShadow="0 4 16 0 #40000000">
                    <Border CornerRadius="{StaticResource CornerRadiusLG}"
                            Background="{DynamicResource ToastBackgroundBrush}"
                            ClipToBounds="True">
                        <Grid ColumnDefinitions="3,Auto,*,Auto">
                            <!-- Accent strip -->
                            <Border Grid.Column="0"
                                    CornerRadius="12,0,0,12">
                                <Border.Background>
                                    <Binding Path="Type">
                                        <Binding.Converter>
                                            <conv:ObjectToObject DefaultValue="{StaticResource ToastInfoAccentBrush}">
                                                <conv:MapItem From="{x:Static toasts:ToastType.Success}" To="{StaticResource ToastSuccessAccentBrush}"/>
                                                <conv:MapItem From="{x:Static toasts:ToastType.Error}" To="{StaticResource ToastErrorAccentBrush}"/>
                                                <conv:MapItem From="{x:Static toasts:ToastType.Info}" To="{StaticResource ToastInfoAccentBrush}"/>
                                            </conv:ObjectToObject>
                                        </Binding.Converter>
                                    </Binding>
                                </Border.Background>
                            </Border>

                            <!-- Icon badge -->
                            <Border Grid.Column="1"
                                    Width="32"
                                    Height="32"
                                    CornerRadius="{StaticResource CornerRadiusMD}"
                                    Margin="{theme:Spacing Left=MD, Right=MD, Y=MD}"
                                    VerticalAlignment="Center"
                                    Background="{DynamicResource ToastIconBadgeBrush}">
                                <mi:MaterialIcon Width="{StaticResource IconSizeSM}"
                                                 Height="{StaticResource IconSizeSM}"
                                                 HorizontalAlignment="Center"
                                                 VerticalAlignment="Center">
                                    <mi:MaterialIcon.Foreground>
                                        <Binding Path="Type">
                                            <Binding.Converter>
                                                <conv:ObjectToObject DefaultValue="{StaticResource ToastInfoAccentBrush}">
                                                    <conv:MapItem From="{x:Static toasts:ToastType.Success}" To="{StaticResource ToastSuccessAccentBrush}"/>
                                                    <conv:MapItem From="{x:Static toasts:ToastType.Error}" To="{StaticResource ToastErrorAccentBrush}"/>
                                                    <conv:MapItem From="{x:Static toasts:ToastType.Info}" To="{StaticResource ToastInfoAccentBrush}"/>
                                                </conv:ObjectToObject>
                                            </Binding.Converter>
                                        </Binding>
                                    </mi:MaterialIcon.Foreground>
                                    <mi:MaterialIcon.Kind>
                                        <Binding Path="Type">
                                            <Binding.Converter>
                                                <conv:ObjectToObject DefaultValue="{x:Static mik:MaterialIconKind.InformationOutline}">
                                                    <conv:MapItem From="{x:Static toasts:ToastType.Success}" To="{x:Static mik:MaterialIconKind.CheckCircle}"/>
                                                    <conv:MapItem From="{x:Static toasts:ToastType.Error}" To="{x:Static mik:MaterialIconKind.AlertCircle}"/>
                                                    <conv:MapItem From="{x:Static toasts:ToastType.Info}" To="{x:Static mik:MaterialIconKind.InformationOutline}"/>
                                                </conv:ObjectToObject>
                                            </Binding.Converter>
                                        </Binding>
                                    </mi:MaterialIcon.Kind>
                                </mi:MaterialIcon>
                            </Border>

                            <!-- Message -->
                            <TextBlock Grid.Column="2"
                                       Text="{Binding Message}"
                                       VerticalAlignment="Center"
                                       TextWrapping="Wrap"
                                       Foreground="{DynamicResource ToastForegroundBrush}"
                                       FontWeight="SemiBold"
                                       Margin="{theme:Spacing Y=MD, Right=SM}"/>

                            <!-- Close button -->
                            <Button Grid.Column="3"
                                    Command="{Binding DismissCommand}"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Width="32"
                                    Height="32"
                                    Padding="0"
                                    Margin="{theme:Spacing Right=SM}"
                                    VerticalAlignment="Center"
                                    Cursor="Hand"
                                    CornerRadius="{StaticResource CornerRadiusButton}">
                                <Button.Styles>
                                    <Style Selector="Button">
                                        <Setter Property="Opacity" Value="0.6"/>
                                    </Style>
                                    <Style Selector="Button:pointerover">
                                        <Setter Property="Opacity" Value="1"/>
                                        <Setter Property="Background" Value="{DynamicResource ToastCloseButtonHoverBrush}"/>
                                    </Style>
                                </Button.Styles>
                                <mi:MaterialIcon Kind="Close"
                                                 Width="{StaticResource IconSizeSM}"
                                                 Height="{StaticResource IconSizeSM}"
                                                 Foreground="{DynamicResource ToastForegroundBrush}"/>
                            </Button>
                        </Grid>
                    </Border>
                </Border>
            </DataTemplate>

            <!-- Action toast (with button) -->
            <DataTemplate x:DataType="toasts:ActionToastItemViewModel">
                <Border CornerRadius="{StaticResource CornerRadiusLG}"
                        MaxWidth="360"
                        MinWidth="240"
                        BoxShadow="0 4 16 0 #40000000">
                    <Border CornerRadius="{StaticResource CornerRadiusLG}"
                            Background="{DynamicResource ToastBackgroundBrush}"
                            ClipToBounds="True">
                        <Grid ColumnDefinitions="3,Auto,*,Auto">
                            <!-- Accent strip -->
                            <Border Grid.Column="0"
                                    CornerRadius="12,0,0,12">
                                <Border.Background>
                                    <Binding Path="Type">
                                        <Binding.Converter>
                                            <conv:ObjectToObject DefaultValue="{StaticResource ToastInfoAccentBrush}">
                                                <conv:MapItem From="{x:Static toasts:ToastType.Success}" To="{StaticResource ToastSuccessAccentBrush}"/>
                                                <conv:MapItem From="{x:Static toasts:ToastType.Error}" To="{StaticResource ToastErrorAccentBrush}"/>
                                                <conv:MapItem From="{x:Static toasts:ToastType.Info}" To="{StaticResource ToastInfoAccentBrush}"/>
                                            </conv:ObjectToObject>
                                        </Binding.Converter>
                                    </Binding>
                                </Border.Background>
                            </Border>

                            <!-- Icon badge -->
                            <Border Grid.Column="1"
                                    Width="32"
                                    Height="32"
                                    CornerRadius="{StaticResource CornerRadiusMD}"
                                    Margin="{theme:Spacing Left=MD, Right=MD, Y=MD}"
                                    VerticalAlignment="Top"
                                    Background="{DynamicResource ToastIconBadgeBrush}">
                                <mi:MaterialIcon Width="{StaticResource IconSizeSM}"
                                                 Height="{StaticResource IconSizeSM}"
                                                 HorizontalAlignment="Center"
                                                 VerticalAlignment="Center">
                                    <mi:MaterialIcon.Foreground>
                                        <Binding Path="Type">
                                            <Binding.Converter>
                                                <conv:ObjectToObject DefaultValue="{StaticResource ToastInfoAccentBrush}">
                                                    <conv:MapItem From="{x:Static toasts:ToastType.Success}" To="{StaticResource ToastSuccessAccentBrush}"/>
                                                    <conv:MapItem From="{x:Static toasts:ToastType.Error}" To="{StaticResource ToastErrorAccentBrush}"/>
                                                    <conv:MapItem From="{x:Static toasts:ToastType.Info}" To="{StaticResource ToastInfoAccentBrush}"/>
                                                </conv:ObjectToObject>
                                            </Binding.Converter>
                                        </Binding>
                                    </mi:MaterialIcon.Foreground>
                                    <mi:MaterialIcon.Kind>
                                        <Binding Path="Type">
                                            <Binding.Converter>
                                                <conv:ObjectToObject DefaultValue="{x:Static mik:MaterialIconKind.InformationOutline}">
                                                    <conv:MapItem From="{x:Static toasts:ToastType.Success}" To="{x:Static mik:MaterialIconKind.CheckCircle}"/>
                                                    <conv:MapItem From="{x:Static toasts:ToastType.Error}" To="{x:Static mik:MaterialIconKind.AlertCircle}"/>
                                                    <conv:MapItem From="{x:Static toasts:ToastType.Info}" To="{x:Static mik:MaterialIconKind.InformationOutline}"/>
                                                </conv:ObjectToObject>
                                            </Binding.Converter>
                                        </Binding>
                                    </mi:MaterialIcon.Kind>
                                </mi:MaterialIcon>
                            </Border>

                            <!-- Content: message + action button -->
                            <StackPanel Grid.Column="2" Spacing="{theme:Gap SM}" Margin="{theme:Spacing Y=MD, Right=SM}">
                                <TextBlock Text="{Binding Message}"
                                           TextWrapping="Wrap"
                                           Foreground="{DynamicResource ToastForegroundBrush}"
                                           FontWeight="SemiBold"/>

                                <Button Command="{Binding ExecuteActionCommand}"
                                        CornerRadius="{StaticResource CornerRadiusButton}"
                                        Padding="{theme:Spacing X=MD, Y=XS}"
                                        HorizontalAlignment="Left"
                                        Cursor="Hand"
                                        BorderThickness="0">
                                    <Button.Background>
                                        <Binding Path="Type">
                                            <Binding.Converter>
                                                <conv:ObjectToObject DefaultValue="{StaticResource ToastInfoAccentBrush}">
                                                    <conv:MapItem From="{x:Static toasts:ToastType.Success}" To="{StaticResource ToastSuccessAccentBrush}"/>
                                                    <conv:MapItem From="{x:Static toasts:ToastType.Error}" To="{StaticResource ToastErrorAccentBrush}"/>
                                                    <conv:MapItem From="{x:Static toasts:ToastType.Info}" To="{StaticResource ToastInfoAccentBrush}"/>
                                                </conv:ObjectToObject>
                                            </Binding.Converter>
                                        </Binding>
                                    </Button.Background>
                                    <Button.Styles>
                                        <Style Selector="Button:pointerover">
                                            <Setter Property="Opacity" Value="0.9"/>
                                        </Style>
                                    </Button.Styles>
                                    <StackPanel Orientation="Horizontal" Spacing="{theme:Gap Icon}">
                                        <mi:MaterialIcon Kind="{Binding ActionIcon}"
                                                         Width="{StaticResource IconSizeXS}"
                                                         Height="{StaticResource IconSizeXS}"
                                                         VerticalAlignment="Center"
                                                         Foreground="{DynamicResource OnAccentTextBrush}"/>
                                        <TextBlock Text="{Binding ActionText}"
                                                   VerticalAlignment="Center"
                                                   Classes="m1"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource OnAccentTextBrush}"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>

                            <!-- Close button -->
                            <Button Grid.Column="3"
                                    Command="{Binding DismissCommand}"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Width="32"
                                    Height="32"
                                    Padding="0"
                                    Margin="{theme:Spacing Top=SM, Right=SM}"
                                    VerticalAlignment="Top"
                                    Cursor="Hand"
                                    CornerRadius="{StaticResource CornerRadiusButton}">
                                <Button.Styles>
                                    <Style Selector="Button">
                                        <Setter Property="Opacity" Value="0.6"/>
                                    </Style>
                                    <Style Selector="Button:pointerover">
                                        <Setter Property="Opacity" Value="1"/>
                                        <Setter Property="Background" Value="{DynamicResource ToastCloseButtonHoverBrush}"/>
                                    </Style>
                                </Button.Styles>
                                <mi:MaterialIcon Kind="Close"
                                                 Width="{StaticResource IconSizeSM}"
                                                 Height="{StaticResource IconSizeSM}"
                                                 Foreground="{DynamicResource ToastForegroundBrush}"/>
                            </Button>
                        </Grid>
                    </Border>
                </Border>
            </DataTemplate>

            <!-- File transfer progress toast -->
            <DataTemplate x:DataType="toasts:TransferToastItemViewModel">
                <Border CornerRadius="{StaticResource CornerRadiusLG}"
                        MaxWidth="320"
                        MinWidth="260"
                        BoxShadow="0 4 16 0 #40000000">
                    <Border CornerRadius="{StaticResource CornerRadiusLG}"
                            Background="{DynamicResource ToastTransferBackgroundBrush}"
                            ClipToBounds="True">
                        <Grid ColumnDefinitions="3,*">
                            <!-- Accent strip -->
                            <Border Grid.Column="0"
                                    CornerRadius="12,0,0,12"
                                    Background="{StaticResource ToastTransferAccentBrush}"/>

                            <!-- Content -->
                            <Grid Grid.Column="1" RowDefinitions="Auto,Auto,Auto,Auto" Margin="{theme:Spacing MD}">
                                <!-- Row 0: Header with icon badge, direction label, cancel button -->
                                <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto">
                                    <!-- Icon badge -->
                                    <Border Grid.Column="0"
                                            Width="32"
                                            Height="32"
                                            CornerRadius="{StaticResource CornerRadiusMD}"
                                            Background="{DynamicResource ToastIconBadgeBrush}"
                                            Margin="{theme:Spacing Right=SM}"
                                            VerticalAlignment="Center">
                                        <mi:MaterialIcon Kind="{Binding IsUpload, Converter={conv:BoolToObject TrueValue={x:Static mik:MaterialIconKind.CloudUpload}, FalseValue={x:Static mik:MaterialIconKind.CloudDownload}}}"
                                                         Width="{StaticResource IconSizeSM}"
                                                         Height="{StaticResource IconSizeSM}"
                                                         HorizontalAlignment="Center"
                                                         VerticalAlignment="Center"
                                                         Foreground="{StaticResource ToastTransferAccentBrush}"/>
                                    </Border>

                                    <TextBlock Grid.Column="1"
                                               Text="{Binding IsUpload, Converter={conv:BoolToObject TrueValue='Sending file', FalseValue='Receiving file'}}"
                                               VerticalAlignment="Center"
                                               Foreground="{DynamicResource ToastForegroundBrush}"
                                               FontWeight="SemiBold" />

                                    <Button Grid.Column="2"
                                            Command="{Binding CancelCommand}"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Width="32"
                                            Height="32"
                                            Padding="0"
                                            VerticalAlignment="Center"
                                            Cursor="Hand"
                                            CornerRadius="{StaticResource CornerRadiusButton}"
                                            ToolTip.Tip="Cancel transfer">
                                        <Button.Styles>
                                            <Style Selector="Button">
                                                <Setter Property="Opacity" Value="0.6"/>
                                            </Style>
                                            <Style Selector="Button:pointerover">
                                                <Setter Property="Opacity" Value="1"/>
                                                <Setter Property="Background" Value="{DynamicResource ToastCloseButtonHoverBrush}"/>
                                            </Style>
                                        </Button.Styles>
                                        <mi:MaterialIcon Kind="Close"
                                                         Width="{StaticResource IconSizeSM}"
                                                         Height="{StaticResource IconSizeSM}"
                                                         Foreground="{DynamicResource ToastForegroundBrush}"/>
                                    </Button>
                                </Grid>

                                <!-- Row 1: Filename -->
                                <TextBlock Grid.Row="1"
                                           Text="{Binding Transfer.FileName}"
                                           TextTrimming="CharacterEllipsis"
                                           Foreground="{DynamicResource ToastSecondaryTextBrush}"
                                           Classes="m1"
                                           Margin="{theme:Spacing Top=SM, Bottom=SM}"
                                           ToolTip.Tip="{Binding Transfer.FileName}"/>

                                <!-- Row 2: Progress bar -->
                                <Border Grid.Row="2"
                                        Height="6"
                                        CornerRadius="3"
                                        Background="{DynamicResource ToastProgressBackgroundBrush}">
                                    <Border CornerRadius="3"
                                            HorizontalAlignment="Left"
                                            Background="{StaticResource ToastTransferAccentBrush}">
                                        <Border.Width>
                                            <MultiBinding>
                                                <MultiBinding.Converter>
                                                    <conv:ProgressWidthConverter/>
                                                </MultiBinding.Converter>
                                                <Binding Path="Transfer.Progress"/>
                                                <Binding Path="$parent[Border].Bounds.Width"/>
                                            </MultiBinding>
                                        </Border.Width>
                                    </Border>
                                </Border>

                                <!-- Row 3: Footer - waiting text OR size/percent -->
                                <TextBlock Grid.Row="3"
                                           Text="Waiting for approval..."
                                           Foreground="{DynamicResource ToastMutedTextBrush}"
                                           Classes="m1"
                                           FontStyle="Italic"
                                           Margin="{theme:Spacing Top=SM}">
                                    <TextBlock.IsVisible>
                                        <Binding Path="Transfer.State">
                                            <Binding.Converter>
                                                <conv:ObjectToObject DefaultValue="False">
                                                    <conv:MapItem From="{x:Static ft:FileTransferState.Pending}" To="True"/>
                                                    <conv:MapItem From="{x:Static ft:FileTransferState.WaitingForAcceptance}" To="True"/>
                                                </conv:ObjectToObject>
                                            </Binding.Converter>
                                        </Binding>
                                    </TextBlock.IsVisible>
                                </TextBlock>

                                <Grid Grid.Row="3"
                                      ColumnDefinitions="*,Auto"
                                      Margin="{theme:Spacing Top=SM}">
                                    <Grid.IsVisible>
                                        <Binding Path="Transfer.State">
                                            <Binding.Converter>
                                                <conv:ObjectToObject DefaultValue="False">
                                                    <conv:MapItem From="{x:Static ft:FileTransferState.Transferring}" To="True"/>
                                                </conv:ObjectToObject>
                                            </Binding.Converter>
                                        </Binding>
                                    </Grid.IsVisible>
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding Transfer.FileSizeFormatted}"
                                               Foreground="{DynamicResource ToastMutedTextBrush}"
                                               Classes="m1"/>

                                    <TextBlock Grid.Column="1"
                                               Text="{Binding Transfer.ProgressPercent, StringFormat={}{0}%}"
                                               Foreground="{DynamicResource ToastSecondaryTextBrush}"
                                               Classes="m1"
                                               FontWeight="SemiBold"/>
                                </Grid>
                            </Grid>
                        </Grid>
                    </Border>
                </Border>
            </DataTemplate>
        </ItemsControl.DataTemplates>
    </ItemsControl>
</UserControl>
